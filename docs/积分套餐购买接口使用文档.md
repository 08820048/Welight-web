# ç§¯åˆ†å¥—é¤è´­ä¹°æ¥å£ä½¿ç”¨æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ç§¯åˆ†å¥—é¤è´­ä¹°æ¥å£ï¼ŒåŒ…æ‹¬å¥—é¤æŸ¥è¯¢ã€è´­ä¹°æµç¨‹ã€æ”¯ä»˜å¤„ç†ç­‰å®Œæ•´çš„è´­ä¹°ä½“éªŒã€‚

### åŸºç¡€ä¿¡æ¯

- **åŸºç¡€URL**: `https://ilikexff.cn/api`
- **å†…å®¹ç±»å‹**: `application/json`
- **å­—ç¬¦ç¼–ç **: `UTF-8`
- **æ”¯ä»˜æ–¹å¼**: æ”¯æŒå¾®ä¿¡æ”¯ä»˜æ”¯ä»˜æ–¹å¼

## ç›®å½•

1. [ç§¯åˆ†å¥—é¤æŸ¥è¯¢](#1-ç§¯åˆ†å¥—é¤æŸ¥è¯¢)
2. [åˆ›å»ºè´­ä¹°è®¢å•](#2-åˆ›å»ºè´­ä¹°è®¢å•)
3. [æ”¯ä»˜æµç¨‹å¤„ç†](#3-æ”¯ä»˜æµç¨‹å¤„ç†)
4. [è®¢å•çŠ¶æ€æŸ¥è¯¢](#4-è®¢å•çŠ¶æ€æŸ¥è¯¢)
5. [å®Œæ•´è´­ä¹°æµç¨‹](#5-å®Œæ•´è´­ä¹°æµç¨‹)
6. [é”™è¯¯å¤„ç†](#6-é”™è¯¯å¤„ç†)
7. [å‰ç«¯é›†æˆç¤ºä¾‹](#7-å‰ç«¯é›†æˆç¤ºä¾‹)

---

## 1. ç§¯åˆ†å¥—é¤æŸ¥è¯¢

### 1.1 è·å–æ‰€æœ‰ç§¯åˆ†å¥—é¤

**æ¥å£åœ°å€**: `GET /credits/packages`

**æ¥å£æè¿°**: è·å–æ‰€æœ‰å¯ç”¨çš„ç§¯åˆ†å¥—é¤ï¼ŒåŒ…æ‹¬é¢„è®¾å¥—é¤å’Œè‡ªå®šä¹‰ç§¯åˆ†é€‰é¡¹

**è¯·æ±‚ç¤ºä¾‹**:

```http
GET /credits/packages
Content-Type: application/json
```

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "è·å–ç§¯åˆ†å¥—é¤æˆåŠŸ",
  "data": [
    {
      "id": 1,
      "packageCode": "CREDITS_200",
      "packageName": "åŸºç¡€å¥—é¤",
      "packageDescription": "é€‚åˆè½»åº¦ä½¿ç”¨çš„ç”¨æˆ·",
      "credits": 200,
      "originalPrice": 10.0,
      "currentPrice": 10.0,
      "discount": 0,
      "packageType": "STANDARD",
      "isActive": true,
      "displayOrder": 1,
      "features": ["200ç§¯åˆ†", "é€‚ç”¨äºæ‰€æœ‰AIæœåŠ¡", "æ°¸ä¸è¿‡æœŸ"],
      "costPerCredit": 0.05,
      "recommendedFor": "è½»åº¦ä½¿ç”¨ç”¨æˆ·"
    },
    {
      "id": 2,
      "packageCode": "CREDITS_500",
      "packageName": "æ ‡å‡†å¥—é¤",
      "packageDescription": "æœ€å—æ¬¢è¿çš„é€‰æ‹©",
      "credits": 500,
      "originalPrice": 25.0,
      "currentPrice": 25.0,
      "discount": 0,
      "packageType": "STANDARD",
      "isActive": true,
      "displayOrder": 2,
      "features": ["500ç§¯åˆ†", "é€‚ç”¨äºæ‰€æœ‰AIæœåŠ¡", "æ°¸ä¸è¿‡æœŸ", "æ€§ä»·æ¯”æœ€é«˜"],
      "costPerCredit": 0.05,
      "recommendedFor": "ä¸­åº¦ä½¿ç”¨ç”¨æˆ·",
      "isPopular": true
    },
    {
      "id": 3,
      "packageCode": "CREDITS_1000",
      "packageName": "é«˜çº§å¥—é¤",
      "packageDescription": "é‡åº¦ç”¨æˆ·çš„æœ€ä½³é€‰æ‹©",
      "credits": 1000,
      "originalPrice": 49.0,
      "currentPrice": 49.0,
      "discount": 0,
      "packageType": "STANDARD",
      "isActive": true,
      "displayOrder": 3,
      "features": ["1000ç§¯åˆ†", "é€‚ç”¨äºæ‰€æœ‰AIæœåŠ¡", "æ°¸ä¸è¿‡æœŸ", "å¤§å®¹é‡ä¼˜æƒ "],
      "costPerCredit": 0.049,
      "recommendedFor": "é‡åº¦ä½¿ç”¨ç”¨æˆ·"
    },
    {
      "id": 4,
      "packageCode": "CREDITS_CUSTOM",
      "packageName": "è‡ªå®šä¹‰ç§¯åˆ†",
      "packageDescription": "æŒ‰éœ€è´­ä¹°ï¼Œçµæ´»é€‰æ‹©",
      "credits": 0,
      "originalPrice": 0.0,
      "currentPrice": 0.0,
      "discount": 0,
      "packageType": "CUSTOM",
      "isActive": true,
      "displayOrder": 4,
      "features": ["è‡ªå®šä¹‰ç§¯åˆ†æ•°é‡", "æœ€ä½100ç§¯åˆ†èµ·è´­", "æŒ‰0.05å…ƒ/ç§¯åˆ†è®¡è´¹", "é€‚ç”¨äºæ‰€æœ‰AIæœåŠ¡"],
      "costPerCredit": 0.05,
      "minCredits": 100,
      "maxCredits": 10000,
      "recommendedFor": "æœ‰ç‰¹å®šéœ€æ±‚çš„ç”¨æˆ·"
    }
  ],
  "timestamp": 1704067200000
}
```

### 1.2 è·å–å•ä¸ªå¥—é¤è¯¦æƒ…

**æ¥å£åœ°å€**: `GET /credits/packages/{packageCode}`

**æ¥å£æè¿°**: è·å–æŒ‡å®šå¥—é¤çš„è¯¦ç»†ä¿¡æ¯

**è·¯å¾„å‚æ•°**:

- `packageCode` (string): å¥—é¤ä»£ç ï¼Œå¦‚ "CREDITS_200"

**è¯·æ±‚ç¤ºä¾‹**:

```http
GET /credits/packages/CREDITS_500
```

**å“åº”ç¤ºä¾‹**: è¿”å›å•ä¸ªå¥—é¤å¯¹è±¡ï¼Œæ ¼å¼åŒä¸Š

---

## 2. åˆ›å»ºè´­ä¹°è®¢å•

### 2.1 åˆ›å»ºç§¯åˆ†å¥—é¤è®¢å•

**æ¥å£åœ°å€**: `POST /credits/purchase`

**æ¥å£æè¿°**: åˆ›å»ºç§¯åˆ†å¥—é¤è´­ä¹°è®¢å•ï¼Œæ”¯æŒé¢„è®¾å¥—é¤å’Œè‡ªå®šä¹‰ç§¯åˆ†è´­ä¹°

**è¯·æ±‚ä½“**:

```json
{
  "packageCode": "CREDITS_500",
  "customerEmail": "user@example.com",
  "customerName": "å¼ ä¸‰",
  "paymentMethod": "WECHAT_PAY",
  "customCredits": null,
  "clientInfo": {
    "userAgent": "Mozilla/5.0...",
    "ipAddress": "192.168.1.1",
    "deviceType": "WEB"
  }
}
```

**å­—æ®µè¯´æ˜**:

- `packageCode` (string): å¥—é¤ä»£ç ï¼Œå¿…å¡«
  - é¢„è®¾å¥—é¤: "CREDITS_200", "CREDITS_500", "CREDITS_1000"
  - è‡ªå®šä¹‰ç§¯åˆ†: "CREDITS_CUSTOM"
- `customerEmail` (string): å®¢æˆ·é‚®ç®±ï¼Œå¿…å¡«
- `customerName` (string): å®¢æˆ·å§“åï¼Œå¿…å¡«
- `paymentMethod` (string): æ”¯ä»˜æ–¹å¼ï¼Œå¿…å¡«
  - "WECHAT_PAY": å¾®ä¿¡æ”¯ä»˜
  - "ALIPAY": æ”¯ä»˜å®
  - "BANK_CARD": é“¶è¡Œå¡æ”¯ä»˜
- `customCredits` (int): è‡ªå®šä¹‰ç§¯åˆ†æ•°é‡ï¼Œä»…å½“packageCodeä¸º"CREDITS_CUSTOM"æ—¶å¿…å¡«
- `clientInfo` (object): å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œå¯é€‰

**è‡ªå®šä¹‰ç§¯åˆ†è´­ä¹°ç¤ºä¾‹**:

```json
{
  "packageCode": "CREDITS_CUSTOM",
  "customerEmail": "user@example.com",
  "customerName": "æå››",
  "paymentMethod": "ALIPAY",
  "customCredits": 300,
  "clientInfo": {
    "userAgent": "Mozilla/5.0...",
    "ipAddress": "192.168.1.1",
    "deviceType": "WEB"
  }
}
```

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "è®¢å•åˆ›å»ºæˆåŠŸ",
  "data": {
    "orderId": "ORDER_20240101_001",
    "packageInfo": {
      "packageCode": "CREDITS_500",
      "packageName": "æ ‡å‡†å¥—é¤",
      "credits": 500,
      "price": 25.0
    },
    "customerInfo": {
      "email": "user@example.com",
      "name": "å¼ ä¸‰"
    },
    "paymentInfo": {
      "paymentMethod": "WECHAT_PAY",
      "amount": 25.0,
      "currency": "CNY",
      "paymentUrl": "https://pay.weixin.qq.com/...",
      "qrCodeUrl": "https://api.qrserver.com/v1/create-qr-code/?data=...",
      "expireTime": "2024-01-01T12:30:00"
    },
    "orderStatus": "PENDING_PAYMENT",
    "createdAt": "2024-01-01T12:00:00",
    "expireAt": "2024-01-01T12:30:00"
  },
  "timestamp": 1704067200000
}
```

---

## 3. æ”¯ä»˜æµç¨‹å¤„ç†

### 3.1 æ”¯ä»˜çŠ¶æ€è¯´æ˜

| çŠ¶æ€            | è¯´æ˜     | ä¸‹ä¸€æ­¥æ“ä½œ           |
| --------------- | -------- | -------------------- |
| PENDING_PAYMENT | ç­‰å¾…æ”¯ä»˜ | ç”¨æˆ·å®Œæˆæ”¯ä»˜         |
| PAID            | æ”¯ä»˜æˆåŠŸ | ç³»ç»Ÿè‡ªåŠ¨å‘æ”¾ç§¯åˆ†     |
| CANCELLED       | è®¢å•å–æ¶ˆ | æ— éœ€æ“ä½œ             |
| EXPIRED         | è®¢å•è¿‡æœŸ | é‡æ–°åˆ›å»ºè®¢å•         |
| FAILED          | æ”¯ä»˜å¤±è´¥ | é‡æ–°æ”¯ä»˜æˆ–åˆ›å»ºæ–°è®¢å• |

### 3.2 æ”¯ä»˜æ–¹å¼å¤„ç†

#### å¾®ä¿¡æ”¯ä»˜

```javascript
// 1. åˆ›å»ºè®¢å•åè·å–æ”¯ä»˜URL
const orderResponse = await createOrder({
  packageCode: 'CREDITS_500',
  paymentMethod: 'WECHAT_PAY'
  // ... å…¶ä»–å‚æ•°
})

// 2. æ˜¾ç¤ºäºŒç»´ç ä¾›ç”¨æˆ·æ‰«ç æ”¯ä»˜
const qrCodeUrl = orderResponse.data.paymentInfo.qrCodeUrl
displayQRCode(qrCodeUrl)

// 3. è½®è¯¢è®¢å•çŠ¶æ€
const checkPaymentStatus = async (orderId) => {
  const response = await fetch(`/payment-orders/${orderId}/status`)
  const data = await response.json()
  return data.data.status
}

// 4. å®šæ—¶æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
const pollPaymentStatus = (orderId) => {
  const interval = setInterval(async () => {
    const status = await checkPaymentStatus(orderId)

    if (status === 'PAID') {
      clearInterval(interval)
      showSuccessMessage('æ”¯ä»˜æˆåŠŸï¼Œç§¯åˆ†å·²åˆ°è´¦ï¼')
      redirectToUserCenter()
    } else if (status === 'EXPIRED' || status === 'FAILED') {
      clearInterval(interval)
      showErrorMessage('æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡æ–°è´­ä¹°')
    }
  }, 2000) // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
}
```

#### æ”¯ä»˜å®æ”¯ä»˜

```javascript
// æ”¯ä»˜å®æ”¯ä»˜æµç¨‹ç±»ä¼¼ï¼Œä½†é€šå¸¸ä¼šè·³è½¬åˆ°æ”¯ä»˜å®é¡µé¢
const orderResponse = await createOrder({
  packageCode: 'CREDITS_1000',
  paymentMethod: 'ALIPAY'
  // ... å…¶ä»–å‚æ•°
})

// è·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢
window.location.href = orderResponse.data.paymentInfo.paymentUrl
```

---

## 4. è®¢å•çŠ¶æ€æŸ¥è¯¢

### 4.1 æŸ¥è¯¢è®¢å•çŠ¶æ€

**æ¥å£åœ°å€**: `GET /payment-orders/{orderId}/status`

**æ¥å£æè¿°**: æŸ¥è¯¢æŒ‡å®šè®¢å•çš„æ”¯ä»˜çŠ¶æ€

**è·¯å¾„å‚æ•°**:

- `orderId` (string): è®¢å•ID

**è¯·æ±‚ç¤ºä¾‹**:

```http
GET /payment-orders/ORDER_20240101_001/status
```

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "æŸ¥è¯¢è®¢å•çŠ¶æ€æˆåŠŸ",
  "data": {
    "orderId": "ORDER_20240101_001",
    "status": "PAID",
    "amount": 25.0,
    "paidAt": "2024-01-01T12:05:30",
    "creditsGranted": true,
    "creditsAmount": 500
  },
  "timestamp": 1704067200000
}
```

### 4.2 æŸ¥è¯¢ç”¨æˆ·è®¢å•å†å²

**æ¥å£åœ°å€**: `GET /payment-orders/user/{email}`

**æ¥å£æè¿°**: æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰è®¢å•å†å²

**è·¯å¾„å‚æ•°**:

- `email` (string): ç”¨æˆ·é‚®ç®±

**æŸ¥è¯¢å‚æ•°**:

- `page` (int): é¡µç ï¼Œé»˜è®¤0
- `size` (int): é¡µå¤§å°ï¼Œé»˜è®¤10
- `status` (string): è®¢å•çŠ¶æ€ç­›é€‰ï¼Œå¯é€‰

**è¯·æ±‚ç¤ºä¾‹**:

```http
GET /payment-orders/user/user@example.com?page=0&size=10
```

**å“åº”ç¤ºä¾‹**:

```json
{
  "code": 200,
  "message": "æŸ¥è¯¢è®¢å•å†å²æˆåŠŸ",
  "data": {
    "content": [
      {
        "orderId": "ORDER_20240101_001",
        "packageName": "æ ‡å‡†å¥—é¤",
        "credits": 500,
        "amount": 25.0,
        "status": "PAID",
        "paymentMethod": "WECHAT_PAY",
        "createdAt": "2024-01-01T12:00:00",
        "paidAt": "2024-01-01T12:05:30"
      }
    ],
    "totalElements": 1,
    "totalPages": 1
  },
  "timestamp": 1704067200000
}
```

---

## 5. å®Œæ•´è´­ä¹°æµç¨‹

### 5.1 æ ‡å‡†å¥—é¤è´­ä¹°æµç¨‹

```javascript
class CreditPurchaseService {
  constructor(baseUrl) {
    this.baseUrl = baseUrl
  }

  // 1. è·å–å¥—é¤åˆ—è¡¨
  async getPackages() {
    const response = await fetch(`${this.baseUrl}/credits/packages`)
    return await response.json()
  }

  // 2. åˆ›å»ºè´­ä¹°è®¢å•
  async createOrder(orderData) {
    const response = await fetch(`${this.baseUrl}/credits/purchase`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(orderData)
    })
    return await response.json()
  }

  // 3. æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
  async checkPaymentStatus(orderId) {
    const response = await fetch(`${this.baseUrl}/payment-orders/${orderId}/status`)
    return await response.json()
  }

  // 4. å®Œæ•´è´­ä¹°æµç¨‹
  async purchaseCredits(packageCode, customerInfo, paymentMethod) {
    try {
      // åˆ›å»ºè®¢å•
      const orderResponse = await this.createOrder({
        packageCode,
        customerEmail: customerInfo.email,
        customerName: customerInfo.name,
        paymentMethod
      })

      if (orderResponse.code !== 200) {
        throw new Error(orderResponse.message)
      }

      const { orderId, paymentInfo } = orderResponse.data

      // æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
      this.showPaymentInterface(paymentInfo)

      // è½®è¯¢æ”¯ä»˜çŠ¶æ€
      return await this.pollPaymentStatus(orderId)
    } catch (error) {
      console.error('è´­ä¹°å¤±è´¥:', error)
      throw error
    }
  }

  // 5. è½®è¯¢æ”¯ä»˜çŠ¶æ€
  async pollPaymentStatus(orderId, maxAttempts = 150) {
    // æœ€å¤š5åˆ†é’Ÿ
    return new Promise((resolve, reject) => {
      let attempts = 0

      const interval = setInterval(async () => {
        attempts++

        try {
          const statusResponse = await this.checkPaymentStatus(orderId)
          const status = statusResponse.data.status

          if (status === 'PAID') {
            clearInterval(interval)
            resolve({
              success: true,
              orderId,
              creditsAmount: statusResponse.data.creditsAmount
            })
          } else if (status === 'EXPIRED' || status === 'FAILED') {
            clearInterval(interval)
            reject(new Error(`æ”¯ä»˜${status === 'EXPIRED' ? 'è¶…æ—¶' : 'å¤±è´¥'}`))
          } else if (attempts >= maxAttempts) {
            clearInterval(interval)
            reject(new Error('æ”¯ä»˜è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æ”¯ä»˜çŠ¶æ€'))
          }
        } catch (error) {
          if (attempts >= maxAttempts) {
            clearInterval(interval)
            reject(error)
          }
        }
      }, 2000)
    })
  }

  // 6. æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
  showPaymentInterface(paymentInfo) {
    if (paymentInfo.paymentMethod === 'WECHAT_PAY') {
      // æ˜¾ç¤ºå¾®ä¿¡æ”¯ä»˜äºŒç»´ç 
      this.showQRCode(paymentInfo.qrCodeUrl)
    } else if (paymentInfo.paymentMethod === 'ALIPAY') {
      // è·³è½¬åˆ°æ”¯ä»˜å®
      window.location.href = paymentInfo.paymentUrl
    }
  }

  showQRCode(qrCodeUrl) {
    // å®ç°äºŒç»´ç æ˜¾ç¤ºé€»è¾‘
    const qrCodeImg = document.createElement('img')
    qrCodeImg.src = qrCodeUrl
    qrCodeImg.alt = 'å¾®ä¿¡æ”¯ä»˜äºŒç»´ç '

    // æ·»åŠ åˆ°é¡µé¢ä¸­
    document.getElementById('qr-code-container').appendChild(qrCodeImg)
  }
}
```

### 5.2 è‡ªå®šä¹‰ç§¯åˆ†è´­ä¹°æµç¨‹

```javascript
// è‡ªå®šä¹‰ç§¯åˆ†è´­ä¹°
const purchaseCustomCredits = async (credits, customerInfo) => {
  // éªŒè¯ç§¯åˆ†æ•°é‡
  if (credits < 100 || credits > 10000) {
    throw new Error('ç§¯åˆ†æ•°é‡å¿…é¡»åœ¨100-10000ä¹‹é—´')
  }

  const purchaseService = new CreditPurchaseService('/api')

  return await purchaseService.purchaseCredits(
    'CREDITS_CUSTOM',
    {
      ...customerInfo,
      customCredits: credits
    },
    'WECHAT_PAY'
  )
}

// ä½¿ç”¨ç¤ºä¾‹
try {
  const result = await purchaseCustomCredits(300, {
    email: 'user@example.com',
    name: 'å¼ ä¸‰'
  })

  console.log('è´­ä¹°æˆåŠŸ:', result)
  alert(`è´­ä¹°æˆåŠŸï¼è·å¾—${result.creditsAmount}ç§¯åˆ†`)
} catch (error) {
  console.error('è´­ä¹°å¤±è´¥:', error)
  alert('è´­ä¹°å¤±è´¥: ' + error.message)
}
```

---

## 6. é”™è¯¯å¤„ç†

### 6.1 å¸¸è§é”™è¯¯ç 

| é”™è¯¯ç  | é”™è¯¯ä¿¡æ¯           | è§£å†³æ–¹æ¡ˆ                   |
| ------ | ------------------ | -------------------------- |
| 400    | è¯·æ±‚å‚æ•°æ— æ•ˆ       | æ£€æŸ¥è¯·æ±‚å‚æ•°æ ¼å¼å’Œå¿…å¡«å­—æ®µ |
| 404    | å¥—é¤ä¸å­˜åœ¨         | ç¡®è®¤å¥—é¤ä»£ç æ˜¯å¦æ­£ç¡®       |
| 409    | è®¢å•å·²å­˜åœ¨         | æ£€æŸ¥æ˜¯å¦é‡å¤æäº¤è®¢å•       |
| 422    | è‡ªå®šä¹‰ç§¯åˆ†æ•°é‡æ— æ•ˆ | ç¡®ä¿ç§¯åˆ†æ•°é‡åœ¨å…è®¸èŒƒå›´å†…   |
| 500    | æœåŠ¡å™¨é”™è¯¯         | ç¨åé‡è¯•æˆ–è”ç³»å®¢æœ         |

### 6.2 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

```javascript
const handlePurchaseError = (error, errorCode) => {
  switch (errorCode) {
    case 400:
      showError('è¯·æ±‚å‚æ•°æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯')
      break
    case 404:
      showError('æ‰€é€‰å¥—é¤ä¸å­˜åœ¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•')
      break
    case 409:
      showError('è®¢å•å·²å­˜åœ¨ï¼Œè¯·å‹¿é‡å¤æäº¤')
      break
    case 422:
      showError('ç§¯åˆ†æ•°é‡æ— æ•ˆï¼Œè¯·é€‰æ‹©100-10000ä¹‹é—´çš„æ•°é‡')
      break
    case 500:
      showError('ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•')
      break
    default:
      showError('è´­ä¹°å¤±è´¥: ' + error.message)
  }
}
```

---

## 7. å‰ç«¯é›†æˆç¤ºä¾‹

### 7.1 Reactç»„ä»¶ç¤ºä¾‹

```jsx
import React, { useState, useEffect } from 'react'

const CreditPurchase = () => {
  const [packages, setPackages] = useState([])
  const [selectedPackage, setSelectedPackage] = useState(null)
  const [customCredits, setCustomCredits] = useState(100)
  const [loading, setLoading] = useState(false)
  const [paymentStatus, setPaymentStatus] = useState(null)

  // è·å–å¥—é¤åˆ—è¡¨
  useEffect(() => {
    fetchPackages()
  }, [])

  const fetchPackages = async () => {
    try {
      const response = await fetch('/api/credits/packages')
      const data = await response.json()
      setPackages(data.data)
    } catch (error) {
      console.error('è·å–å¥—é¤å¤±è´¥:', error)
    }
  }

  // è´­ä¹°ç§¯åˆ†
  const handlePurchase = async (packageCode, paymentMethod) => {
    setLoading(true)

    try {
      const orderData = {
        packageCode,
        customerEmail: 'user@example.com', // ä»ç”¨æˆ·çŠ¶æ€è·å–
        customerName: 'ç”¨æˆ·å§“å', // ä»ç”¨æˆ·çŠ¶æ€è·å–
        paymentMethod,
        ...(packageCode === 'CREDITS_CUSTOM' && { customCredits })
      }

      const response = await fetch('/api/credits/purchase', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderData)
      })

      const result = await response.json()

      if (result.code === 200) {
        // æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
        showPaymentInterface(result.data)
        // å¼€å§‹è½®è¯¢æ”¯ä»˜çŠ¶æ€
        pollPaymentStatus(result.data.orderId)
      } else {
        throw new Error(result.message)
      }
    } catch (error) {
      alert('è´­ä¹°å¤±è´¥: ' + error.message)
    } finally {
      setLoading(false)
    }
  }

  const showPaymentInterface = (orderData) => {
    // æ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç æˆ–è·³è½¬æ”¯ä»˜é¡µé¢
    setPaymentStatus('waiting')
  }

  const pollPaymentStatus = (orderId) => {
    const interval = setInterval(async () => {
      try {
        const response = await fetch(`/api/payment-orders/${orderId}/status`)
        const data = await response.json()

        if (data.data.status === 'PAID') {
          clearInterval(interval)
          setPaymentStatus('success')
          alert('æ”¯ä»˜æˆåŠŸï¼ç§¯åˆ†å·²åˆ°è´¦')
        } else if (data.data.status === 'EXPIRED' || data.data.status === 'FAILED') {
          clearInterval(interval)
          setPaymentStatus('failed')
          alert('æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•')
        }
      } catch (error) {
        console.error('æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€å¤±è´¥:', error)
      }
    }, 2000)
  }

  return (
    <div className="credit-purchase">
      <h2>è´­ä¹°ç§¯åˆ†</h2>

      {/* å¥—é¤åˆ—è¡¨ */}
      <div className="packages">
        {packages.map((pkg) => (
          <div key={pkg.id} className={`package ${pkg.isPopular ? 'popular' : ''}`}>
            <h3>{pkg.packageName}</h3>
            <p>{pkg.packageDescription}</p>
            <div className="price">Â¥{pkg.currentPrice}</div>
            <div className="credits">{pkg.credits}ç§¯åˆ†</div>

            {pkg.packageType === 'CUSTOM' ? (
              <div>
                <input
                  type="number"
                  min="100"
                  max="10000"
                  value={customCredits}
                  onChange={(e) => setCustomCredits(parseInt(e.target.value))}
                />
                <span>ç§¯åˆ† (Â¥{(customCredits * 0.05).toFixed(2)})</span>
              </div>
            ) : null}

            <button
              onClick={() => handlePurchase(pkg.packageCode, 'WECHAT_PAY')}
              disabled={loading}
            >
              {loading ? 'å¤„ç†ä¸­...' : 'å¾®ä¿¡æ”¯ä»˜'}
            </button>

            <button onClick={() => handlePurchase(pkg.packageCode, 'ALIPAY')} disabled={loading}>
              {loading ? 'å¤„ç†ä¸­...' : 'æ”¯ä»˜å®'}
            </button>
          </div>
        ))}
      </div>

      {/* æ”¯ä»˜çŠ¶æ€ */}
      {paymentStatus === 'waiting' && (
        <div className="payment-waiting">
          <p>è¯·å®Œæˆæ”¯ä»˜...</p>
          <div className="qr-code-container" id="qr-code-container"></div>
        </div>
      )}
    </div>
  )
}

export default CreditPurchase
```

---

## æ³¨æ„äº‹é¡¹

1. **è®¢å•æœ‰æ•ˆæœŸ**: è®¢å•åˆ›å»ºå30åˆ†é’Ÿå†…æœ‰æ•ˆï¼Œè¶…æ—¶è‡ªåŠ¨å–æ¶ˆ
2. **æ”¯ä»˜å®‰å…¨**: æ‰€æœ‰æ”¯ä»˜éƒ½é€šè¿‡ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°å¤„ç†ï¼Œç¡®ä¿èµ„é‡‘å®‰å…¨
3. **ç§¯åˆ†åˆ°è´¦**: æ”¯ä»˜æˆåŠŸåç§¯åˆ†ä¼šç«‹å³åˆ°è´¦ï¼Œæ— éœ€ç­‰å¾…
4. **é‡å¤è´­ä¹°**: æ”¯æŒå¤šæ¬¡è´­ä¹°ï¼Œç§¯åˆ†ä¼šç´¯åŠ åˆ°è´¦æˆ·ä¸­
5. **é€€æ¬¾æ”¿ç­–**: ç§¯åˆ†ä¸€æ—¦è´­ä¹°æˆåŠŸï¼ŒåŸåˆ™ä¸Šä¸æ”¯æŒé€€æ¬¾
6. **å®¢æœæ”¯æŒ**: å¦‚é‡é—®é¢˜ï¼Œè¯·è”ç³»å®¢æœå¤„ç†

---

> ğŸ“ **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> ğŸ•’ **æœ€åæ›´æ–°**: 2024-01-01  
> ğŸ‘¨â€ğŸ’» **ç»´æŠ¤è€…**: ApexBlogå¼€å‘å›¢é˜Ÿ

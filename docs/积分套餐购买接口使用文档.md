# 积分套餐购买接口使用文档

## 概述

本文档详细介绍如何使用积分套餐购买接口，包括套餐查询、购买流程、支付处理等完整的购买体验。

### 基础信息

- **基础URL**: `https://ilikexff.cn/api`
- **内容类型**: `application/json`
- **字符编码**: `UTF-8`
- **支付方式**: 支持微信支付支付方式

## 目录

1. [积分套餐查询](#1-积分套餐查询)
2. [创建购买订单](#2-创建购买订单)
3. [支付流程处理](#3-支付流程处理)
4. [订单状态查询](#4-订单状态查询)
5. [完整购买流程](#5-完整购买流程)
6. [错误处理](#6-错误处理)
7. [前端集成示例](#7-前端集成示例)

---

## 1. 积分套餐查询

### 1.1 获取所有积分套餐

**接口地址**: `GET /credits/packages`

**接口描述**: 获取所有可用的积分套餐，包括预设套餐和自定义积分选项

**请求示例**:

```http
GET /credits/packages
Content-Type: application/json
```

**响应示例**:

```json
{
  "code": 200,
  "message": "获取积分套餐成功",
  "data": [
    {
      "id": 1,
      "packageCode": "CREDITS_200",
      "packageName": "基础套餐",
      "packageDescription": "适合轻度使用的用户",
      "credits": 200,
      "originalPrice": 10.0,
      "currentPrice": 10.0,
      "discount": 0,
      "packageType": "STANDARD",
      "isActive": true,
      "displayOrder": 1,
      "features": ["200积分", "适用于所有AI服务", "永不过期"],
      "costPerCredit": 0.05,
      "recommendedFor": "轻度使用用户"
    },
    {
      "id": 2,
      "packageCode": "CREDITS_500",
      "packageName": "标准套餐",
      "packageDescription": "最受欢迎的选择",
      "credits": 500,
      "originalPrice": 25.0,
      "currentPrice": 25.0,
      "discount": 0,
      "packageType": "STANDARD",
      "isActive": true,
      "displayOrder": 2,
      "features": ["500积分", "适用于所有AI服务", "永不过期", "性价比最高"],
      "costPerCredit": 0.05,
      "recommendedFor": "中度使用用户",
      "isPopular": true
    },
    {
      "id": 3,
      "packageCode": "CREDITS_1000",
      "packageName": "高级套餐",
      "packageDescription": "重度用户的最佳选择",
      "credits": 1000,
      "originalPrice": 49.0,
      "currentPrice": 49.0,
      "discount": 0,
      "packageType": "STANDARD",
      "isActive": true,
      "displayOrder": 3,
      "features": ["1000积分", "适用于所有AI服务", "永不过期", "大容量优惠"],
      "costPerCredit": 0.049,
      "recommendedFor": "重度使用用户"
    },
    {
      "id": 4,
      "packageCode": "CREDITS_CUSTOM",
      "packageName": "自定义积分",
      "packageDescription": "按需购买，灵活选择",
      "credits": 0,
      "originalPrice": 0.0,
      "currentPrice": 0.0,
      "discount": 0,
      "packageType": "CUSTOM",
      "isActive": true,
      "displayOrder": 4,
      "features": ["自定义积分数量", "最低100积分起购", "按0.05元/积分计费", "适用于所有AI服务"],
      "costPerCredit": 0.05,
      "minCredits": 100,
      "maxCredits": 10000,
      "recommendedFor": "有特定需求的用户"
    }
  ],
  "timestamp": 1704067200000
}
```

### 1.2 获取单个套餐详情

**接口地址**: `GET /credits/packages/{packageCode}`

**接口描述**: 获取指定套餐的详细信息

**路径参数**:

- `packageCode` (string): 套餐代码，如 "CREDITS_200"

**请求示例**:

```http
GET /credits/packages/CREDITS_500
```

**响应示例**: 返回单个套餐对象，格式同上

---

## 2. 创建购买订单

### 2.1 创建积分套餐订单

**接口地址**: `POST /credits/purchase`

**接口描述**: 创建积分套餐购买订单，支持预设套餐和自定义积分购买

**请求体**:

```json
{
  "packageCode": "CREDITS_500",
  "customerEmail": "user@example.com",
  "customerName": "张三",
  "paymentMethod": "WECHAT_PAY",
  "customCredits": null,
  "clientInfo": {
    "userAgent": "Mozilla/5.0...",
    "ipAddress": "192.168.1.1",
    "deviceType": "WEB"
  }
}
```

**字段说明**:

- `packageCode` (string): 套餐代码，必填
  - 预设套餐: "CREDITS_200", "CREDITS_500", "CREDITS_1000"
  - 自定义积分: "CREDITS_CUSTOM"
- `customerEmail` (string): 客户邮箱，必填
- `customerName` (string): 客户姓名，必填
- `paymentMethod` (string): 支付方式，必填
  - "WECHAT_PAY": 微信支付
  - "ALIPAY": 支付宝
  - "BANK_CARD": 银行卡支付
- `customCredits` (int): 自定义积分数量，仅当packageCode为"CREDITS_CUSTOM"时必填
- `clientInfo` (object): 客户端信息，可选

**自定义积分购买示例**:

```json
{
  "packageCode": "CREDITS_CUSTOM",
  "customerEmail": "user@example.com",
  "customerName": "李四",
  "paymentMethod": "ALIPAY",
  "customCredits": 300,
  "clientInfo": {
    "userAgent": "Mozilla/5.0...",
    "ipAddress": "192.168.1.1",
    "deviceType": "WEB"
  }
}
```

**响应示例**:

```json
{
  "code": 200,
  "message": "订单创建成功",
  "data": {
    "orderId": "ORDER_20240101_001",
    "packageInfo": {
      "packageCode": "CREDITS_500",
      "packageName": "标准套餐",
      "credits": 500,
      "price": 25.0
    },
    "customerInfo": {
      "email": "user@example.com",
      "name": "张三"
    },
    "paymentInfo": {
      "paymentMethod": "WECHAT_PAY",
      "amount": 25.0,
      "currency": "CNY",
      "paymentUrl": "https://pay.weixin.qq.com/...",
      "qrCodeUrl": "https://api.qrserver.com/v1/create-qr-code/?data=...",
      "expireTime": "2024-01-01T12:30:00"
    },
    "orderStatus": "PENDING_PAYMENT",
    "createdAt": "2024-01-01T12:00:00",
    "expireAt": "2024-01-01T12:30:00"
  },
  "timestamp": 1704067200000
}
```

---

## 3. 支付流程处理

### 3.1 支付状态说明

| 状态            | 说明     | 下一步操作           |
| --------------- | -------- | -------------------- |
| PENDING_PAYMENT | 等待支付 | 用户完成支付         |
| PAID            | 支付成功 | 系统自动发放积分     |
| CANCELLED       | 订单取消 | 无需操作             |
| EXPIRED         | 订单过期 | 重新创建订单         |
| FAILED          | 支付失败 | 重新支付或创建新订单 |

### 3.2 支付方式处理

#### 微信支付

```javascript
// 1. 创建订单后获取支付URL
const orderResponse = await createOrder({
  packageCode: 'CREDITS_500',
  paymentMethod: 'WECHAT_PAY'
  // ... 其他参数
})

// 2. 显示二维码供用户扫码支付
const qrCodeUrl = orderResponse.data.paymentInfo.qrCodeUrl
displayQRCode(qrCodeUrl)

// 3. 轮询订单状态
const checkPaymentStatus = async (orderId) => {
  const response = await fetch(`/payment-orders/${orderId}/status`)
  const data = await response.json()
  return data.data.status
}

// 4. 定时检查支付状态
const pollPaymentStatus = (orderId) => {
  const interval = setInterval(async () => {
    const status = await checkPaymentStatus(orderId)

    if (status === 'PAID') {
      clearInterval(interval)
      showSuccessMessage('支付成功，积分已到账！')
      redirectToUserCenter()
    } else if (status === 'EXPIRED' || status === 'FAILED') {
      clearInterval(interval)
      showErrorMessage('支付失败，请重新购买')
    }
  }, 2000) // 每2秒检查一次
}
```

#### 支付宝支付

```javascript
// 支付宝支付流程类似，但通常会跳转到支付宝页面
const orderResponse = await createOrder({
  packageCode: 'CREDITS_1000',
  paymentMethod: 'ALIPAY'
  // ... 其他参数
})

// 跳转到支付宝支付页面
window.location.href = orderResponse.data.paymentInfo.paymentUrl
```

---

## 4. 订单状态查询

### 4.1 查询订单状态

**接口地址**: `GET /payment-orders/{orderId}/status`

**接口描述**: 查询指定订单的支付状态

**路径参数**:

- `orderId` (string): 订单ID

**请求示例**:

```http
GET /payment-orders/ORDER_20240101_001/status
```

**响应示例**:

```json
{
  "code": 200,
  "message": "查询订单状态成功",
  "data": {
    "orderId": "ORDER_20240101_001",
    "status": "PAID",
    "amount": 25.0,
    "paidAt": "2024-01-01T12:05:30",
    "creditsGranted": true,
    "creditsAmount": 500
  },
  "timestamp": 1704067200000
}
```

### 4.2 查询用户订单历史

**接口地址**: `GET /payment-orders/user/{email}`

**接口描述**: 查询指定用户的所有订单历史

**路径参数**:

- `email` (string): 用户邮箱

**查询参数**:

- `page` (int): 页码，默认0
- `size` (int): 页大小，默认10
- `status` (string): 订单状态筛选，可选

**请求示例**:

```http
GET /payment-orders/user/user@example.com?page=0&size=10
```

**响应示例**:

```json
{
  "code": 200,
  "message": "查询订单历史成功",
  "data": {
    "content": [
      {
        "orderId": "ORDER_20240101_001",
        "packageName": "标准套餐",
        "credits": 500,
        "amount": 25.0,
        "status": "PAID",
        "paymentMethod": "WECHAT_PAY",
        "createdAt": "2024-01-01T12:00:00",
        "paidAt": "2024-01-01T12:05:30"
      }
    ],
    "totalElements": 1,
    "totalPages": 1
  },
  "timestamp": 1704067200000
}
```

---

## 5. 完整购买流程

### 5.1 标准套餐购买流程

```javascript
class CreditPurchaseService {
  constructor(baseUrl) {
    this.baseUrl = baseUrl
  }

  // 1. 获取套餐列表
  async getPackages() {
    const response = await fetch(`${this.baseUrl}/credits/packages`)
    return await response.json()
  }

  // 2. 创建购买订单
  async createOrder(orderData) {
    const response = await fetch(`${this.baseUrl}/credits/purchase`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(orderData)
    })
    return await response.json()
  }

  // 3. 检查支付状态
  async checkPaymentStatus(orderId) {
    const response = await fetch(`${this.baseUrl}/payment-orders/${orderId}/status`)
    return await response.json()
  }

  // 4. 完整购买流程
  async purchaseCredits(packageCode, customerInfo, paymentMethod) {
    try {
      // 创建订单
      const orderResponse = await this.createOrder({
        packageCode,
        customerEmail: customerInfo.email,
        customerName: customerInfo.name,
        paymentMethod
      })

      if (orderResponse.code !== 200) {
        throw new Error(orderResponse.message)
      }

      const { orderId, paymentInfo } = orderResponse.data

      // 显示支付界面
      this.showPaymentInterface(paymentInfo)

      // 轮询支付状态
      return await this.pollPaymentStatus(orderId)
    } catch (error) {
      console.error('购买失败:', error)
      throw error
    }
  }

  // 5. 轮询支付状态
  async pollPaymentStatus(orderId, maxAttempts = 150) {
    // 最多5分钟
    return new Promise((resolve, reject) => {
      let attempts = 0

      const interval = setInterval(async () => {
        attempts++

        try {
          const statusResponse = await this.checkPaymentStatus(orderId)
          const status = statusResponse.data.status

          if (status === 'PAID') {
            clearInterval(interval)
            resolve({
              success: true,
              orderId,
              creditsAmount: statusResponse.data.creditsAmount
            })
          } else if (status === 'EXPIRED' || status === 'FAILED') {
            clearInterval(interval)
            reject(new Error(`支付${status === 'EXPIRED' ? '超时' : '失败'}`))
          } else if (attempts >= maxAttempts) {
            clearInterval(interval)
            reject(new Error('支付超时，请检查支付状态'))
          }
        } catch (error) {
          if (attempts >= maxAttempts) {
            clearInterval(interval)
            reject(error)
          }
        }
      }, 2000)
    })
  }

  // 6. 显示支付界面
  showPaymentInterface(paymentInfo) {
    if (paymentInfo.paymentMethod === 'WECHAT_PAY') {
      // 显示微信支付二维码
      this.showQRCode(paymentInfo.qrCodeUrl)
    } else if (paymentInfo.paymentMethod === 'ALIPAY') {
      // 跳转到支付宝
      window.location.href = paymentInfo.paymentUrl
    }
  }

  showQRCode(qrCodeUrl) {
    // 实现二维码显示逻辑
    const qrCodeImg = document.createElement('img')
    qrCodeImg.src = qrCodeUrl
    qrCodeImg.alt = '微信支付二维码'

    // 添加到页面中
    document.getElementById('qr-code-container').appendChild(qrCodeImg)
  }
}
```

### 5.2 自定义积分购买流程

```javascript
// 自定义积分购买
const purchaseCustomCredits = async (credits, customerInfo) => {
  // 验证积分数量
  if (credits < 100 || credits > 10000) {
    throw new Error('积分数量必须在100-10000之间')
  }

  const purchaseService = new CreditPurchaseService('/api')

  return await purchaseService.purchaseCredits(
    'CREDITS_CUSTOM',
    {
      ...customerInfo,
      customCredits: credits
    },
    'WECHAT_PAY'
  )
}

// 使用示例
try {
  const result = await purchaseCustomCredits(300, {
    email: 'user@example.com',
    name: '张三'
  })

  console.log('购买成功:', result)
  alert(`购买成功！获得${result.creditsAmount}积分`)
} catch (error) {
  console.error('购买失败:', error)
  alert('购买失败: ' + error.message)
}
```

---

## 6. 错误处理

### 6.1 常见错误码

| 错误码 | 错误信息           | 解决方案                   |
| ------ | ------------------ | -------------------------- |
| 400    | 请求参数无效       | 检查请求参数格式和必填字段 |
| 404    | 套餐不存在         | 确认套餐代码是否正确       |
| 409    | 订单已存在         | 检查是否重复提交订单       |
| 422    | 自定义积分数量无效 | 确保积分数量在允许范围内   |
| 500    | 服务器错误         | 稍后重试或联系客服         |

### 6.2 错误处理最佳实践

```javascript
const handlePurchaseError = (error, errorCode) => {
  switch (errorCode) {
    case 400:
      showError('请求参数有误，请检查输入信息')
      break
    case 404:
      showError('所选套餐不存在，请刷新页面重试')
      break
    case 409:
      showError('订单已存在，请勿重复提交')
      break
    case 422:
      showError('积分数量无效，请选择100-10000之间的数量')
      break
    case 500:
      showError('系统繁忙，请稍后重试')
      break
    default:
      showError('购买失败: ' + error.message)
  }
}
```

---

## 7. 前端集成示例

### 7.1 React组件示例

```jsx
import React, { useState, useEffect } from 'react'

const CreditPurchase = () => {
  const [packages, setPackages] = useState([])
  const [selectedPackage, setSelectedPackage] = useState(null)
  const [customCredits, setCustomCredits] = useState(100)
  const [loading, setLoading] = useState(false)
  const [paymentStatus, setPaymentStatus] = useState(null)

  // 获取套餐列表
  useEffect(() => {
    fetchPackages()
  }, [])

  const fetchPackages = async () => {
    try {
      const response = await fetch('/api/credits/packages')
      const data = await response.json()
      setPackages(data.data)
    } catch (error) {
      console.error('获取套餐失败:', error)
    }
  }

  // 购买积分
  const handlePurchase = async (packageCode, paymentMethod) => {
    setLoading(true)

    try {
      const orderData = {
        packageCode,
        customerEmail: 'user@example.com', // 从用户状态获取
        customerName: '用户姓名', // 从用户状态获取
        paymentMethod,
        ...(packageCode === 'CREDITS_CUSTOM' && { customCredits })
      }

      const response = await fetch('/api/credits/purchase', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderData)
      })

      const result = await response.json()

      if (result.code === 200) {
        // 显示支付界面
        showPaymentInterface(result.data)
        // 开始轮询支付状态
        pollPaymentStatus(result.data.orderId)
      } else {
        throw new Error(result.message)
      }
    } catch (error) {
      alert('购买失败: ' + error.message)
    } finally {
      setLoading(false)
    }
  }

  const showPaymentInterface = (orderData) => {
    // 显示支付二维码或跳转支付页面
    setPaymentStatus('waiting')
  }

  const pollPaymentStatus = (orderId) => {
    const interval = setInterval(async () => {
      try {
        const response = await fetch(`/api/payment-orders/${orderId}/status`)
        const data = await response.json()

        if (data.data.status === 'PAID') {
          clearInterval(interval)
          setPaymentStatus('success')
          alert('支付成功！积分已到账')
        } else if (data.data.status === 'EXPIRED' || data.data.status === 'FAILED') {
          clearInterval(interval)
          setPaymentStatus('failed')
          alert('支付失败，请重试')
        }
      } catch (error) {
        console.error('查询支付状态失败:', error)
      }
    }, 2000)
  }

  return (
    <div className="credit-purchase">
      <h2>购买积分</h2>

      {/* 套餐列表 */}
      <div className="packages">
        {packages.map((pkg) => (
          <div key={pkg.id} className={`package ${pkg.isPopular ? 'popular' : ''}`}>
            <h3>{pkg.packageName}</h3>
            <p>{pkg.packageDescription}</p>
            <div className="price">¥{pkg.currentPrice}</div>
            <div className="credits">{pkg.credits}积分</div>

            {pkg.packageType === 'CUSTOM' ? (
              <div>
                <input
                  type="number"
                  min="100"
                  max="10000"
                  value={customCredits}
                  onChange={(e) => setCustomCredits(parseInt(e.target.value))}
                />
                <span>积分 (¥{(customCredits * 0.05).toFixed(2)})</span>
              </div>
            ) : null}

            <button
              onClick={() => handlePurchase(pkg.packageCode, 'WECHAT_PAY')}
              disabled={loading}
            >
              {loading ? '处理中...' : '微信支付'}
            </button>

            <button onClick={() => handlePurchase(pkg.packageCode, 'ALIPAY')} disabled={loading}>
              {loading ? '处理中...' : '支付宝'}
            </button>
          </div>
        ))}
      </div>

      {/* 支付状态 */}
      {paymentStatus === 'waiting' && (
        <div className="payment-waiting">
          <p>请完成支付...</p>
          <div className="qr-code-container" id="qr-code-container"></div>
        </div>
      )}
    </div>
  )
}

export default CreditPurchase
```

---

## 注意事项

1. **订单有效期**: 订单创建后30分钟内有效，超时自动取消
2. **支付安全**: 所有支付都通过第三方支付平台处理，确保资金安全
3. **积分到账**: 支付成功后积分会立即到账，无需等待
4. **重复购买**: 支持多次购买，积分会累加到账户中
5. **退款政策**: 积分一旦购买成功，原则上不支持退款
6. **客服支持**: 如遇问题，请联系客服处理

---

> 📝 **文档版本**: v1.0  
> 🕒 **最后更新**: 2024-01-01  
> 👨‍💻 **维护者**: ApexBlog开发团队

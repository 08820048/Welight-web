# 2025-12-27 产品优惠活动与优惠券系统（本次新增功能）接口文档

面向前端对接使用：按“前台接口 / 管理后台接口”划分，包含请求/响应字段说明、鉴权方式与业务规则。

## 1. 对接约定

### 1.1 Base URL 与 Content-Type

- Base URL：`{HOST}/api`
- Content-Type：`application/json; charset=utf-8`
- 时间格式：`yyyy-MM-dd'T'HH:mm:ss`（ISO-8601，无时区，例如 `2025-12-27T00:00:00`）
- 金额格式：`BigDecimal`，保留 2 位小数（示例 `71.28`）
- 折扣格式：`0~1` 的小数（示例 `0.8000` 表示 8 折）

### 1.2 统一响应结构 ApiResponse

所有接口返回结构一致：

| 字段 | 类型 | 说明 |
|---|---|---|
| success | boolean | 是否成功（`code` 在 200-299 之间为 true） |
| code | number | 业务响应码（目前与 HTTP 状态码一致） |
| message | string | 提示信息（失败时包含原因） |
| data | object / array / null | 业务数据 |
| timestamp | number | 服务器时间戳（毫秒） |

成功示例：

```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": {},
  "timestamp": 1730000000000
}
```

失败示例：

```json
{
  "success": false,
  "code": 400,
  "message": "试算失败: 优惠券不存在: XXX",
  "data": null,
  "timestamp": 1730000000000
}
```

### 1.3 HTTP 状态码约定

- 200：成功（`success=true`）
- 400：参数错误/业务校验失败（`success=false`，message 说明原因）
- 401：未登录或 token 无效
- 403：无权限（管理后台需要 ADMIN）
- 500：服务器异常

### 1.4 管理后台鉴权

- 管理后台接口路径前缀：`/api/admin/**`
- Header：`Authorization: Bearer <JWT>`
- 权限：`ROLE_ADMIN`

## 2. 业务规则（本次新增功能）

### 2.1 优惠叠加与最终价计算

1. 取产品原价 `original`
2. 命中活动规则后得到活动价 `afterCampaign`
3. 若传入优惠券码，则在 `afterCampaign` 基础上乘以 `coupon.discountRate` 得到最终价 `final`
4. 活动价与最终价均有最小值保护：`>= 0.01`

### 2.2 活动命中规则与优先级

- 活动筛选：`enabled=true` 且 `startAt <= now < endAt`（排序：`startAt asc, id asc`）
- 规则筛选：`enabled=true`（排序：`sortOrder asc, id asc`）
- 命中策略：从最早开始的活动开始逐条规则匹配，第一条命中即生效

### 2.3 枚举/字典

产品活动规则：

| 字段 | 可选值 | 说明 |
|---|---|---|
| matchType | ALL_PRODUCTS / PRODUCT_CODE_PREFIX / PRODUCT_CODE_EXACT | 匹配范围 |
| discountType | DISCOUNT_RATE / DIRECT_REDUCTION | 折扣 / 直降 |

优惠券：

| 字段 | 可选值 | 说明 |
|---|---|---|
| status | ACTIVE / DISABLED / EXPIRED | 状态 |
| createdSource | ADMIN / LOTTERY | 创建来源 |

## 3. 前台接口（Public API）

### 3.1 获取进行中的活动（含规则）

- Method：`GET`
- Path：`/api/product-activities/active`
- Auth：无

响应 `data`：`ProductActivityCampaignDTO[]`

#### 3.1.1 ProductActivityCampaignDTO 字段

| 字段 | 类型 | 说明 |
|---|---|---|
| id | number | 活动 ID |
| title | string | 活动标题 |
| content | string \| null | 活动内容 |
| startAt | string | 开始时间（ISO-8601） |
| endAt | string | 结束时间（ISO-8601） |
| enabled | boolean | 是否启用 |
| createdAt | string \| null | 创建时间 |
| updatedAt | string \| null | 更新时间 |
| rules | ProductActivityRuleDTO[] | 生效规则列表 |

#### 3.1.2 ProductActivityRuleDTO 字段

| 字段 | 类型 | 说明 |
|---|---|---|
| id | number | 规则 ID |
| campaignId | number | 活动 ID |
| matchType | string | 见「2.3 枚举/字典」 |
| matchValue | string \| null | 前缀/精确 code（ALL_PRODUCTS 可为空） |
| discountType | string | 见「2.3 枚举/字典」 |
| discountRate | number \| null | 折扣（0~1），discountType=DISCOUNT_RATE 时生效 |
| reductionAmount | number \| null | 直降金额，discountType=DIRECT_REDUCTION 时生效 |
| enabled | boolean | 是否启用 |
| sortOrder | number | 越小越优先 |
| createdAt | string \| null | 创建时间 |
| updatedAt | string \| null | 更新时间 |

响应示例：

```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": 1,
      "title": "双旦优惠",
      "content": "全场 8 折",
      "startAt": "2025-12-27T00:00:00",
      "endAt": "2026-01-03T00:00:00",
      "enabled": true,
      "createdAt": "2025-12-27T00:00:00",
      "updatedAt": "2025-12-27T00:00:00",
      "rules": [
        {
          "id": 10,
          "campaignId": 1,
          "matchType": "ALL_PRODUCTS",
          "matchValue": null,
          "discountType": "DISCOUNT_RATE",
          "discountRate": 0.8000,
          "reductionAmount": null,
          "enabled": true,
          "sortOrder": 0,
          "createdAt": "2025-12-27T00:00:00",
          "updatedAt": "2025-12-27T00:00:00"
        }
      ]
    }
  ],
  "timestamp": 1730000000000
}
```

### 3.2 优惠券试算（产品 + 活动 + 优惠券）

- Method：`POST`
- Path：`/api/coupons/preview`
- Auth：无

请求 body：`CouponPreviewRequestDTO`

| 字段 | 类型 | 必填 | 约束 | 说明 |
|---|---|---:|---|---|
| couponCode | string | 是 | max 64 | 优惠券码 |
| productCode | string | 是 | max 50 | 产品 code |
| customerEmail | string | 是 | email,max 100 | 用户邮箱（用于校验每邮箱次数/限定邮箱） |

请求示例：

```json
{
  "couponCode": "WL-ABCDEF",
  "productCode": "LICENSE_PRO",
  "customerEmail": "user@example.com"
}
```

响应 data：`CouponPreviewResponseDTO`

| 字段 | 类型 | 说明 |
|---|---|---|
| couponCode | string | 优惠券码 |
| discountRate | number | 折扣（0~1） |
| originalAmount | number | 产品原价 |
| afterCampaignAmount | number | 应用活动后的价格（若无活动则等于 originalAmount） |
| finalAmount | number | 最终价格（活动价 + 优惠券后） |
| appliedCampaignId | number \| null | 命中的活动 ID |
| appliedCampaignTitle | string \| null | 命中的活动标题 |

响应示例：

```json
{
  "success": true,
  "code": 200,
  "message": "试算成功",
  "data": {
    "couponCode": "WL-ABCDEF",
    "discountRate": 0.9000,
    "originalAmount": 99.00,
    "afterCampaignAmount": 79.20,
    "finalAmount": 71.28,
    "appliedCampaignId": 1,
    "appliedCampaignTitle": "双旦优惠"
  },
  "timestamp": 1730000000000
}
```

常见失败原因（HTTP 400）：

- 产品不可用/不存在
- 优惠券不存在/不在有效期/已达总次数/已达邮箱次数/限定邮箱不匹配

### 3.3 抽奖发券（为邮箱生成优惠券）

- Method：`POST`
- Path：`/api/coupons/lottery`
- Auth：无

请求 body：`CouponLotteryRequestDTO`

| 字段 | 类型 | 必填 | 约束 | 说明 |
|---|---|---:|---|---|
| customerEmail | string | 是 | email,max 100 | 接收优惠券的邮箱 |

响应 data：`CouponLotteryResponseDTO`

| 字段 | 类型 | 说明 |
|---|---|---|
| couponCode | string | 发放的优惠券码 |
| discountRate | number | 折扣（0~1） |
| validFrom | string | 生效时间 |
| validTo | string | 失效时间 |

常见失败原因（HTTP 400）：

- 抽奖功能未开启（SystemConfig：`coupon.lottery.enabled=false`）

### 3.4 创建支付订单（新增：couponCode）

该接口为支付下单入口，本次新增支持传 `couponCode`，并在订单回包中返回活动/优惠券关联字段。

- Method：`POST`
- Path：`/api/payment/orders`
- Auth：无

请求 body：`PaymentOrderCreateDTO`（仅列出与本次功能相关字段）

| 字段 | 类型 | 必填 | 说明 |
|---|---|---:|---|
| productCode | string | 是 | 产品 code |
| customerEmail | string | 是 | 客户邮箱 |
| paymentMethod | string | 是 | 支付方式（例如 WECHAT_NATIVE） |
| couponCode | string \| null | 否 | 优惠券码（max 64） |
| customAmount | number \| null | 否 | 自定义金额（若传入则不走活动/优惠券计算） |

请求示例：

```json
{
  "productCode": "LICENSE_PRO",
  "customerEmail": "user@example.com",
  "paymentMethod": "WECHAT_NATIVE",
  "couponCode": "WL-ABCDEF"
}
```

响应 data（节选）：

| 字段 | 类型 | 说明 |
|---|---|---|
| order.originalAmount | number \| null | 原价（未应用活动/优惠券前） |
| order.amount | number | 最终价（活动 + 优惠券后） |
| order.appliedCampaignId | number \| null | 命中的活动 ID |
| order.appliedCouponId | number \| null | 命中的优惠券 ID |

## 4. 管理后台接口（Admin API）

所有管理后台接口都需要：

- Header：`Authorization: Bearer <JWT>`
- 角色：`ROLE_ADMIN`

### 4.1 产品活动管理

#### 4.1.1 获取活动列表

- Method：`GET`
- Path：`/api/admin/product-activities`

响应 data：`ProductActivityCampaignDTO[]`

说明：列表接口只返回活动基础信息，`rules` 字段可能为 `null`。

#### 4.1.2 获取活动详情（含规则）

- Method：`GET`
- Path：`/api/admin/product-activities/{id}`

Path 参数：

| 参数 | 类型 | 必填 | 说明 |
|---|---|---:|---|
| id | number | 是 | 活动 ID |

响应 data：`ProductActivityCampaignDTO`（包含 `rules`）

#### 4.1.3 创建活动（含规则）

- Method：`POST`
- Path：`/api/admin/product-activities`

请求 body：`AdminUpsertProductActivityCampaignDTO`

| 字段 | 类型 | 必填 | 说明 |
|---|---|---:|---|
| title | string | 是 | 活动标题（max 200） |
| content | string \| null | 否 | 活动说明 |
| startAt | string | 是 | 开始时间 |
| endAt | string | 是 | 结束时间 |
| enabled | boolean | 否 | 默认 true |
| rules | AdminUpsertProductActivityRuleDTO[] \| null | 否 | 规则列表 |

`AdminUpsertProductActivityRuleDTO`：

| 字段 | 类型 | 必填 | 说明 |
|---|---|---:|---|
| matchType | string | 是 | 见「2.3 枚举/字典」 |
| matchValue | string \| null | 否 | max 100 |
| discountType | string | 是 | 见「2.3 枚举/字典」 |
| discountRate | number \| null | 否 | 折扣（0~1） |
| reductionAmount | number \| null | 否 | 直降金额 |
| enabled | boolean | 否 | 默认 true |
| sortOrder | number | 是 | 默认 0 |

请求示例：

```json
{
  "title": "双旦优惠",
  "content": "全场 8 折",
  "startAt": "2025-12-27T00:00:00",
  "endAt": "2026-01-03T00:00:00",
  "enabled": true,
  "rules": [
    {
      "matchType": "ALL_PRODUCTS",
      "matchValue": null,
      "discountType": "DISCOUNT_RATE",
      "discountRate": 0.8000,
      "reductionAmount": null,
      "enabled": true,
      "sortOrder": 0
    }
  ]
}
```

#### 4.1.4 更新活动（会重置规则）

- Method：`PUT`
- Path：`/api/admin/product-activities/{id}`

说明：更新接口会先删除该活动原有规则，再按请求 body 重新写入规则；因此前端更新时应始终提交完整的 `rules` 列表。

#### 4.1.5 删除活动

- Method：`DELETE`
- Path：`/api/admin/product-activities/{id}`

### 4.2 优惠券管理

#### 4.2.1 获取优惠券列表

- Method：`GET`
- Path：`/api/admin/coupons`

响应 data：`CouponDTO[]`

`CouponDTO` 字段（节选）：

| 字段 | 类型 | 说明 |
|---|---|---|
| id | number | 优惠券 ID |
| code | string | 优惠券码 |
| discountRate | number | 折扣（0~1） |
| status | string | ACTIVE/DISABLED/EXPIRED |
| validFrom | string \| null | 生效时间（为空表示立即生效） |
| validTo | string \| null | 失效时间（为空表示长期有效） |
| totalRedemptionLimit | number \| null | 总次数限制（为空不限制） |
| perEmailLimit | number \| null | 单邮箱次数限制（为空不限制） |
| redeemedCount | number | 已核销次数 |
| createdSource | string | ADMIN/LOTTERY |
| issuedToEmail | string \| null | 限定邮箱（为空不限定） |
| remark | string \| null | 备注 |
| metadata | string \| null | 扩展信息（JSON 字符串） |

#### 4.2.2 创建优惠券

- Method：`POST`
- Path：`/api/admin/coupons`

请求 body：`AdminCreateCouponDTO`

| 字段 | 类型 | 必填 | 约束 | 说明 |
|---|---|---:|---|---|
| code | string | 是 | max 64 | 优惠券码（全局唯一） |
| discountRate | number | 是 | 0.0001~1.0000 | 折扣 |
| validFrom | string \| null | 否 |  | 生效时间 |
| validTo | string \| null | 否 |  | 失效时间 |
| totalRedemptionLimit | number \| null | 否 |  | 总次数限制 |
| perEmailLimit | number \| null | 否 |  | 单邮箱次数限制 |
| issuedToEmail | string \| null | 否 | max 100 | 限定邮箱 |
| remark | string \| null | 否 | max 500 | 备注 |
| metadata | string \| null | 否 |  | 扩展信息 |

#### 4.2.3 更新优惠券

- Method：`PUT`
- Path：`/api/admin/coupons/{id}`

请求 body：`AdminUpdateCouponDTO`（字段均为可选，非空才会更新）

#### 4.2.4 删除优惠券

- Method：`DELETE`
- Path：`/api/admin/coupons/{id}`

## 5. 前端展示字段变更（产品价格展示）

产品展示/详情接口返回的产品 DTO 新增以下字段（用于前端展示活动信息与最终价）：

| 字段 | 类型 | 说明 |
|---|---|---|
| originalPrice | number \| null | 原价 |
| finalPrice | number \| null | 最终价（活动价） |
| appliedCampaignId | number \| null | 命中的活动 ID |
| appliedCampaignTitle | string \| null | 命中的活动标题 |
| appliedDiscountType | string \| null | DISCOUNT_RATE / DIRECT_REDUCTION |
| appliedDiscountRate | number \| null | 折扣 |
| appliedReductionAmount | number \| null | 直降金额 |

## 6. 数据库变更（摘要）

对应 SQL：`sql/20251227_product_activity_and_coupon.sql`

- 新增：活动表/规则表、优惠券表、优惠券预占核销表
- 扩展：订单表增加原价与关联活动/优惠券字段

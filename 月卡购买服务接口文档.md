# 月卡服务API接口文档

## 文档信息
- **版本**: v1.0
- **创建日期**: 2025-09-25
- **更新日期**: 2025-09-25
- **作者**: xuyi

## 概述

本文档描述了WeLight桌面应用的月卡服务API接口，包括AI服务月卡和云存储服务月卡的购买、激活、验证等功能。

### 服务类型
- **AI_SERVICE**: AI服务月卡（智能写作、代码生成、图像处理等）
- **CLOUD_STORAGE**: 云存储服务月卡（100GB存储空间、文件同步等）

### 月卡特性
- **有效期**: 30天（从激活时开始计算）
- **激活方式**: 用户主动激活，激活后开始计时
- **验证机制**: 应用端定期调用验证接口检查有效性
- **状态管理**: 支持未激活、已激活、已过期、已暂停、已撤销等状态

## 接口列表

### 1. 购买月卡

**接口地址**: `POST /monthly-cards/purchase`

**接口描述**: 创建月卡购买订单并获取支付信息

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| serviceType | String | 是 | 服务类型（AI_SERVICE 或 CLOUD_STORAGE） |
| customerEmail | String | 是 | 客户邮箱 |
| customerName | String | 否 | 客户姓名 |
| clientInfo | String | 否 | 客户端信息 |
| paymentMethod | String | 是 | 支付方式（默认WECHAT_NATIVE） |
| remark | String | 否 | 备注信息 |

#### 请求示例

```json
{
  "serviceType": "AI_SERVICE",
  "customerEmail": "user@example.com",
  "customerName": "张三",
  "clientInfo": "WeLight v3.0.0 (MacIntel)",
  "paymentMethod": "WECHAT_NATIVE",
  "remark": "AI服务月卡购买"
}
```

#### 响应示例

```json
{
  "success": true,
  "message": "月卡购买订单创建成功",
  "data": {
    "order": {
      "id": 12345,
      "orderNo": "WL1727251200001ABC",
      "productName": "AI服务月卡",
      "amount": 29.90,
      "currency": "CNY",
      "status": "PENDING",
      "paymentMethod": "WECHAT_NATIVE",
      "customerEmail": "user@example.com",
      "expiredAt": "2025-09-25T15:30:00",
      "createdAt": "2025-09-25T15:00:00"
    },
    "qrCode": "weixin://wxpay/bizpayurl?pr=abc123def",
    "paymentUrl": "/api/payment/page/WL1727251200001ABC"
  }
}
```

### 2. 激活月卡

**接口地址**: `POST /monthly-cards/activate`

**接口描述**: 激活指定的月卡，激活后开始30天倒计时

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| cardCode | String | 是 | 月卡编码 |
| customerEmail | String | 是 | 客户邮箱（用于验证） |
| clientInfo | String | 否 | 客户端信息 |

#### 请求示例

```json
{
  "cardCode": "AI-1727251200001-ABC12345",
  "customerEmail": "user@example.com",
  "clientInfo": "WeLight v3.0.0 (MacIntel)"
}
```

#### 响应示例

```json
{
  "success": true,
  "message": "月卡激活成功",
  "data": {
    "valid": true,
    "cardInfo": {
      "cardCode": "AI-1727251200001-ABC12345",
      "serviceType": "AI_SERVICE",
      "serviceTypeDescription": "AI服务",
      "status": "ACTIVE",
      "statusDescription": "已激活",
      "activatedAt": "2025-09-25T15:00:00",
      "expiredAt": "2025-10-25T15:00:00",
      "remainingDays": 30,
      "remainingHours": 720,
      "expired": false
    }
  }
}
```

### 3. 验证月卡

**接口地址**: `POST /monthly-cards/validate`

**接口描述**: 验证月卡是否有效，用于应用端定期检查

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| cardCode | String | 是 | 月卡编码 |
| customerEmail | String | 是 | 客户邮箱（用于验证） |
| serviceType | String | 否 | 服务类型（额外验证） |

#### 请求示例

```json
{
  "cardCode": "AI-1727251200001-ABC12345",
  "customerEmail": "user@example.com",
  "serviceType": "AI_SERVICE"
}
```

#### 响应示例（验证成功）

```json
{
  "success": true,
  "message": "月卡验证成功",
  "data": {
    "valid": true,
    "cardInfo": {
      "cardCode": "AI-1727251200001-ABC12345",
      "serviceType": "AI_SERVICE",
      "serviceTypeDescription": "AI服务",
      "status": "ACTIVE",
      "statusDescription": "已激活",
      "activatedAt": "2025-09-25T15:00:00",
      "expiredAt": "2025-10-25T15:00:00",
      "remainingDays": 25,
      "remainingHours": 600,
      "expired": false
    }
  }
}
```

#### 响应示例（验证失败）

```json
{
  "success": false,
  "message": "月卡已过期",
  "data": {
    "valid": false,
    "failureReason": "月卡已过期"
  }
}
```

### 4. 查询月卡信息

**接口地址**: `GET /monthly-cards/{cardCode}`

**接口描述**: 根据月卡编码查询月卡详细信息

#### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| cardCode | String | 是 | 月卡编码 |

#### 响应示例

```json
{
  "success": true,
  "data": {
    "id": 1001,
    "cardCode": "AI-1727251200001-ABC12345",
    "serviceType": "AI_SERVICE",
    "serviceTypeDescription": "AI服务",
    "customerEmail": "user@example.com",
    "customerName": "张三",
    "status": "ACTIVE",
    "statusDescription": "已激活",
    "activatedAt": "2025-09-25T15:00:00",
    "expiredAt": "2025-10-25T15:00:00",
    "createdAt": "2025-09-25T14:30:00",
    "updatedAt": "2025-09-25T15:00:00",
    "valid": true,
    "expired": false,
    "canActivate": false,
    "remainingDays": 25,
    "remainingHours": 600
  }
}
```

### 5. 查询客户月卡列表

**接口地址**: `GET /monthly-cards`

**接口描述**: 根据客户邮箱查询月卡列表

#### 查询参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| customerEmail | String | 是 | 客户邮箱 |
| serviceType | String | 否 | 服务类型过滤 |

#### 请求示例

```
GET /monthly-cards?customerEmail=user@example.com&serviceType=AI_SERVICE
```

#### 响应示例

```json
{
  "success": true,
  "data": [
    {
      "id": 1001,
      "cardCode": "AI-1727251200001-ABC12345",
      "serviceType": "AI_SERVICE",
      "serviceTypeDescription": "AI服务",
      "customerEmail": "user@example.com",
      "customerName": "张三",
      "status": "ACTIVE",
      "statusDescription": "已激活",
      "activatedAt": "2025-09-25T15:00:00",
      "expiredAt": "2025-10-25T15:00:00",
      "createdAt": "2025-09-25T14:30:00",
      "valid": true,
      "expired": false,
      "remainingDays": 25
    }
  ]
}
```

### 6. 检查有效月卡

**接口地址**: `GET /monthly-cards/check-valid`

**接口描述**: 检查客户是否有指定服务的有效月卡

#### 查询参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| customerEmail | String | 是 | 客户邮箱 |
| serviceType | String | 是 | 服务类型 |

#### 请求示例

```
GET /monthly-cards/check-valid?customerEmail=user@example.com&serviceType=AI_SERVICE
```

#### 响应示例

```json
{
  "success": true,
  "data": {
    "hasValidCard": true
  }
}
```

### 7. 查询订单状态

**接口地址**: `GET /payment/orders/{orderNo}`

**接口描述**: 查询月卡购买订单的支付状态，用于轮询检查支付是否完成

#### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| orderNo | String | 是 | 订单号 |

#### 请求示例

```
GET /payment/orders/WL1727251200001ABC
```

#### 响应示例（未支付）

```json
{
  "success": true,
  "data": {
    "id": 12345,
    "orderNo": "WL1727251200001ABC",
    "productName": "AI服务月卡",
    "amount": 29.90,
    "currency": "CNY",
    "status": "PENDING",
    "paid": false,
    "paymentMethod": "WECHAT_NATIVE",
    "customerEmail": "user@example.com",
    "expiredAt": "2025-09-25T15:30:00",
    "createdAt": "2025-09-25T15:00:00"
  }
}
```

#### 响应示例（已支付）

```json
{
  "success": true,
  "data": {
    "id": 12345,
    "orderNo": "WL1727251200001ABC",
    "productName": "AI服务月卡",
    "amount": 29.90,
    "currency": "CNY",
    "status": "PAID",
    "paid": true,
    "paymentMethod": "WECHAT_NATIVE",
    "customerEmail": "user@example.com",
    "paidAt": "2025-09-25T15:05:00",
    "expiredAt": "2025-09-25T15:30:00",
    "createdAt": "2025-09-25T15:00:00"
  }
}
```

## 错误处理

### 错误响应格式

```json
{
  "success": false,
  "message": "错误描述",
  "code": "ERROR_CODE",
  "timestamp": "2025-09-25T15:00:00"
}
```

### 常见错误码

| 错误码 | HTTP状态码 | 说明 |
|--------|------------|------|
| CARD_NOT_FOUND | 404 | 月卡不存在 |
| CARD_ALREADY_ACTIVATED | 400 | 月卡已激活 |
| CARD_EXPIRED | 400 | 月卡已过期 |
| EMAIL_MISMATCH | 400 | 邮箱不匹配 |
| SERVICE_TYPE_MISMATCH | 400 | 服务类型不匹配 |
| INVALID_SERVICE_TYPE | 400 | 无效的服务类型 |
| PAYMENT_FAILED | 400 | 支付失败 |
| VALIDATION_ERROR | 400 | 参数验证失败 |

## 集成建议

### 1. 购买流程
1. 调用购买接口创建订单
2. 引导用户完成支付
3. **轮询订单状态**：每5秒调用 `GET /payment/orders/{orderNo}` 检查支付状态
4. 支付成功后系统自动生成月卡并发送邮件
5. 用户收到包含月卡编码的邮件

#### 轮询检查示例代码

```javascript
// 轮询检查支付状态
const pollPaymentStatus = (orderNo) => {
  const interval = setInterval(async () => {
    try {
      const response = await fetch(`/api/payment/orders/${orderNo}`);
      const data = await response.json();

      if (data.success && data.data.paid) {
        clearInterval(interval);
        console.log('支付成功！月卡已发送到邮箱');
        // 提示用户查看邮箱
        showEmailCheckPrompt();
      }
    } catch (error) {
      console.error('查询订单状态失败:', error);
    }
  }, 5000); // 每5秒检查一次

  // 30分钟后停止轮询
  setTimeout(() => clearInterval(interval), 30 * 60 * 1000);
};

// 使用示例
const purchaseResult = await purchaseMonthlyCard(purchaseData);
if (purchaseResult.success) {
  // 开始轮询支付状态
  pollPaymentStatus(purchaseResult.data.order.orderNo);
}
```

### 2. 激活流程
1. 用户在应用中输入月卡编码和邮箱
2. 调用激活接口
3. 激活成功后开始30天倒计时
4. 应用端记录激活状态

### 3. 验证流程
1. 应用启动时验证月卡
2. 定期（如每小时）调用验证接口
3. 验证失败时禁用相关功能
4. 提醒用户续费或重新购买

### 4. 错误处理
- 网络异常时使用本地缓存的验证结果
- 验证失败时给用户明确的提示信息
- 提供便捷的续费购买入口

## 注意事项

1. **安全性**: 所有接口都需要验证客户邮箱，防止恶意使用
2. **幂等性**: 激活接口支持重复调用，不会重复激活
3. **时区**: 所有时间均为服务器本地时间
4. **缓存**: 验证结果可以短时间缓存，减少接口调用
5. **监控**: 建议监控月卡使用情况和异常验证请求

## 完整购买流程示例

### JavaScript/Node.js 示例

```javascript
class MonthlyCardManager {
  constructor(baseUrl = 'https://ilikexff.cn/api') {
    this.baseUrl = baseUrl;
  }

  // 购买月卡
  async purchaseMonthlyCard(serviceType, customerEmail, customerName) {
    try {
      // 1. 创建订单
      const orderResponse = await fetch(`${this.baseUrl}/monthly-cards/purchase`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          serviceType,
          customerEmail,
          customerName,
          paymentMethod: 'WECHAT_NATIVE'
        })
      });

      const orderData = await orderResponse.json();
      if (!orderData.success) {
        throw new Error(orderData.message);
      }

      const { order, qrCode, paymentUrl } = orderData.data;

      // 2. 打开支付页面（在浏览器环境中）
      if (typeof window !== 'undefined') {
        window.open(`https://ilikexff.cn${paymentUrl}`, '_blank');
      }

      // 3. 开始轮询支付状态
      this.pollPaymentStatus(order.orderNo);

      return {
        order,
        qrCode,
        paymentUrl,
        message: '支付页面已打开，请完成支付后查看邮箱获取月卡编码'
      };

    } catch (error) {
      console.error('购买月卡失败:', error);
      throw error;
    }
  }

  // 轮询支付状态
  pollPaymentStatus(orderNo) {
    const interval = setInterval(async () => {
      try {
        const isPaid = await this.checkOrderStatus(orderNo);
        if (isPaid) {
          clearInterval(interval);
          console.log('支付成功！月卡已发送到邮箱');
          this.showEmailCheckPrompt();
        }
      } catch (error) {
        console.error('查询订单状态失败:', error);
      }
    }, 5000); // 每5秒检查一次

    // 30分钟后停止轮询
    setTimeout(() => {
      clearInterval(interval);
      console.log('支付轮询已停止');
    }, 30 * 60 * 1000);
  }

  // 检查订单状态
  async checkOrderStatus(orderNo) {
    try {
      const response = await fetch(`${this.baseUrl}/payment/orders/${orderNo}`);
      const data = await response.json();

      if (data.success) {
        return data.data.paid; // true表示已支付
      }
      return false;
    } catch (error) {
      console.error('查询订单状态失败:', error);
      return false;
    }
  }

  // 激活月卡
  async activateCard(cardCode, customerEmail) {
    try {
      const response = await fetch(`${this.baseUrl}/monthly-cards/activate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          cardCode,
          customerEmail
        })
      });

      const data = await response.json();
      if (!data.success) {
        throw new Error(data.message);
      }

      return data.data;
    } catch (error) {
      console.error('激活月卡失败:', error);
      throw error;
    }
  }

  // 验证月卡
  async validateCard(cardCode, customerEmail, serviceType) {
    try {
      const response = await fetch(`${this.baseUrl}/monthly-cards/validate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          cardCode,
          customerEmail,
          serviceType
        })
      });

      const data = await response.json();
      return data.success ? data.data : { valid: false, failureReason: data.message };
    } catch (error) {
      console.error('验证月卡失败:', error);
      return { valid: false, failureReason: '网络错误' };
    }
  }

  // 显示邮箱检查提示
  showEmailCheckPrompt() {
    if (typeof window !== 'undefined') {
      alert('支付成功！请查看邮箱获取月卡编码，然后在应用中激活月卡。');
    } else {
      console.log('支付成功！请查看邮箱获取月卡编码。');
    }
  }
}

// 使用示例
const cardManager = new MonthlyCardManager();

// 1. 购买AI服务月卡
cardManager.purchaseMonthlyCard('AI_SERVICE', 'user@example.com', '张三')
  .then(result => {
    console.log('购买流程启动:', result.message);
  })
  .catch(error => {
    console.error('购买失败:', error);
  });

// 2. 用户收到邮件后激活月卡
const activateCardFromEmail = async (cardCode, customerEmail) => {
  try {
    const result = await cardManager.activateCard(cardCode, customerEmail);
    console.log('月卡激活成功:', result);

    // 保存月卡信息到本地
    localStorage.setItem('monthlyCard', JSON.stringify(result.cardInfo));

    return result;
  } catch (error) {
    console.error('月卡激活失败:', error);
    throw error;
  }
};

// 3. 应用启动时验证月卡
const checkCardOnStartup = async () => {
  try {
    // 从本地获取月卡信息
    const cardInfo = JSON.parse(localStorage.getItem('monthlyCard') || '{}');

    if (!cardInfo.cardCode) {
      return { valid: false, reason: 'NO_CARD' };
    }

    // 验证月卡
    const result = await cardManager.validateCard(
      cardInfo.cardCode,
      cardInfo.customerEmail,
      cardInfo.serviceType
    );

    if (result.valid) {
      // 更新本地缓存
      localStorage.setItem('monthlyCard', JSON.stringify(result.cardInfo));
    }

    return result;
  } catch (error) {
    console.error('月卡验证失败:', error);
    return { valid: false, reason: 'NETWORK_ERROR' };
  }
};
```

## 更新日志

### v1.0 (2025-09-25)
- 初始版本发布
- 支持AI服务和云存储服务月卡
- 实现购买、激活、验证完整流程
- 添加支付状态轮询机制
- 完善邮件通知功能

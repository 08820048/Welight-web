# 二维码获取方式变更说明

## 变更概述

为了解决第三方二维码服务不稳定的问题，现在改为使用后端生成二维码并上传到阿里云OSS存储。

## 变更对比

### 🔴 之前的方式（已废弃）

前端自己拼接第三方服务URL：
```javascript
// ❌ 旧方式 - 不稳定，经常加载失败
const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrCodeData)}`;
```

### 🟢 现在的方式（推荐）

直接使用后端提供的二维码图片接口：
```javascript
// ✅ 新方式 - 稳定的OSS存储
const qrImageUrl = `/api/payment/orders/${orderNo}/qrcode-image`;
```

## 接口说明

### 获取二维码图片

**接口**: `GET /api/payment/orders/{orderNo}/qrcode-image`

**响应**: 
- 成功时返回 `302 重定向` 到OSS上的二维码图片
- 失败时返回本地生成的PNG图片

**示例**:
```
GET /api/payment/orders/WL1727251200001ABC/qrcode-image
↓
302 重定向到: https://ultimate-img.oss-cn-beijing.aliyuncs.com/qrcodes/20250925/qrcode_WL1727251200001ABC_1727251200000.png
```

## 前端使用方式

### 1. 直接在img标签中使用

```html
<img src="/api/payment/orders/WL1727251200001ABC/qrcode-image" 
     alt="支付二维码" 
     style="width: 200px; height: 200px;" />
```

### 2. 在JavaScript中使用

```javascript
// 获取订单号后直接使用
const orderNo = 'WL1727251200001ABC';
const qrImageUrl = `https://ilikexff.cn/api/payment/orders/${orderNo}/qrcode-image`;

// 设置到img元素
document.getElementById('qrcode').src = qrImageUrl;
```

### 3. 在React/Vue中使用

```jsx
// React
function PaymentQRCode({ orderNo }) {
  const qrImageUrl = `https://ilikexff.cn/api/payment/orders/${orderNo}/qrcode-image`;
  
  return (
    <img 
      src={qrImageUrl}
      alt="支付二维码"
      style={{ width: 200, height: 200 }}
    />
  );
}
```

```vue
<!-- Vue -->
<template>
  <img 
    :src="qrImageUrl"
    alt="支付二维码"
    style="width: 200px; height: 200px;"
  />
</template>

<script>
export default {
  props: ['orderNo'],
  computed: {
    qrImageUrl() {
      return `https://ilikexff.cn/api/payment/orders/${this.orderNo}/qrcode-image`;
    }
  }
}
</script>
```

## 优势

1. **稳定性**: 使用自有阿里云OSS存储，不依赖第三方服务
2. **速度**: OSS支持CDN加速，访问更快
3. **降级**: OSS失败时自动降级到本地生成
4. **简单**: 前端只需要一个URL，无需处理二维码生成逻辑

## 注意事项

1. **缓存**: 二维码图片会缓存5分钟，避免微信支付URL过期
2. **重试**: 如果图片加载失败，可以重新请求该接口
3. **HTTPS**: 生产环境请使用HTTPS访问

## 迁移步骤

1. 将所有使用 `api.qrserver.com` 的地方替换为新接口
2. 删除前端的二维码生成相关代码
3. 测试确保二维码正常显示

---

**生效时间**: 立即生效  
**影响范围**: 所有支付二维码显示功能

# 许可证购买 API 接口文档

## 概述

本文档专门介绍许可证购买流程相关的 API 接口，包括产品查询、订单创建、支付处理和许可证获取等核心接口。**不包含许可证的激活、验证等功能接口**。

### 基础信息

- **API 基础地址**: `https://ilikexff.cn/api`
- **数据格式**: JSON
- **字符编码**: UTF-8
- **认证要求**: 所有购买相关接口均**无需认证**

## 接口列表

### 1. 查询产品列表

**接口地址**: `GET /products`

**接口描述**: 获取所有可购买的产品信息

**请求示例**:
```bash
curl -X GET "https://ilikexff.cn/api/products"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": 4,
      "code": "WELIGHT_STANDARD",
      "name": "WeLight标准版",
      "description": "WeLight桌面应用标准版许可证，包含完整功能，永久使用",
      "price": 0.99,
      "currency": "CNY",
      "validityDays": -1,
      "maxActivations": 1,
      "permanent": true
    }
  ]
}
```

### 2. 创建支付订单

**接口地址**: `POST /payment/orders`

**接口描述**: 创建支付订单并获取支付信息

**请求参数**:
```json
{
  "productCode": "WELIGHT_STANDARD",
  "customerEmail": "user@example.com",
  "customerName": "张三",
  "clientInfo": "WeLight v2.4.2 (MacIntel)",
  "paymentMethod": "WECHAT_NATIVE",
  "remark": "桌面应用购买"
}
```

**参数说明**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| productCode | string | 是 | 产品代码 |
| customerEmail | string | 是 | 客户邮箱（接收许可证） |
| paymentMethod | string | 是 | 支付方式，默认"WECHAT_NATIVE" |
| customerName | string | 否 | 客户姓名 |
| clientInfo | string | 否 | 客户端信息 |
| remark | string | 否 | 备注信息 |
| customAmount | decimal | 否 | 自定义金额（覆盖产品默认价格） |

**请求示例**:
```bash
curl -X POST "https://ilikexff.cn/api/payment/orders" \
  -H "Content-Type: application/json" \
  -d '{
    "productCode": "WELIGHT_STANDARD",
    "customerEmail": "user@example.com",
    "customerName": "张三",
    "paymentMethod": "WECHAT_NATIVE"
  }'
```

**响应示例**:
```json
{
  "code": 200,
  "message": "订单创建成功",
  "data": {
    "order": {
      "id": 51,
      "orderNo": "WL1758677365048537F0158C",
      "productId": 4,
      "productName": "WeLight标准版",
      "amount": 0.99,
      "currency": "CNY",
      "status": "PENDING",
      "statusDescription": "待支付",
      "paymentMethod": "WECHAT_NATIVE",
      "paymentMethodDescription": "微信扫码支付",
      "customerEmail": "user@example.com",
      "customerName": "张三",
      "clientInfo": "WeLight v2.4.2 (MacIntel)",
      "expiredAt": "2025-09-24T09:59:25",
      "paidAt": null,
      "remark": "桌面应用购买",
      "qrCode": "weixin://wxpay/bizpayurl?pr=w5cCGAMz1",
      "paymentUrl": "/api/payment/page/WL1758677365048537F0158C",
      "createdAt": "2025-09-24T14:31:00",
      "updatedAt": "2025-09-24T14:31:01",
      "expired": false,
      "canPay": true,
      "paid": false
    },
    "qrCode": "weixin://wxpay/bizpayurl?pr=w5cCGAMz1",
    "paymentUrl": "/api/payment/page/WL1758677365048537F0158C"
  }
}
```

### 3. 查询订单状态

**接口地址**: `GET /payment/orders/{orderNo}`

**接口描述**: 查询订单支付状态

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| orderNo | string | 是 | 订单号 |

**请求示例**:
```bash
curl -X GET "https://ilikexff.cn/api/payment/orders/WL1758677365048537F0158C"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 51,
    "orderNo": "WL1758677365048537F0158C",
    "productId": 4,
    "productName": "WeLight标准版",
    "amount": 0.99,
    "currency": "CNY",
    "status": "PAID",
    "statusDescription": "已支付",
    "paymentMethod": "WECHAT_NATIVE",
    "paymentMethodDescription": "微信扫码支付",
    "customerEmail": "user@example.com",
    "customerName": "张三",
    "clientInfo": "WeLight v2.4.2 (MacIntel)",
    "expiredAt": "2025-09-24T09:59:25",
    "paidAt": "2025-09-24T09:35:33",
    "remark": "桌面应用购买",
    "qrCode": "weixin://wxpay/bizpayurl?pr=w5cCGAMz1",
    "paymentUrl": "/api/payment/page/WL1758677365048537F0158C",
    "createdAt": "2025-09-24T14:31:00",
    "updatedAt": "2025-09-24T14:35:33",
    "expired": false,
    "canPay": false,
    "paid": true
  }
}
```

**订单状态说明**:
| 状态 | 说明 |
|------|------|
| PENDING | 待支付 |
| PAID | 已支付 |
| EXPIRED | 已过期 |
| CANCELLED | 已取消 |

### 4. 查询客户许可证列表

**接口地址**: `GET /licenses?customerEmail={email}`

**接口描述**: 根据客户邮箱查询许可证列表

**查询参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| customerEmail | string | 是 | 客户邮箱 |

**请求示例**:
```bash
curl -X GET "https://ilikexff.cn/api/licenses?customerEmail=user@example.com"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "licenseKey": "ABCD-EFGH-IJKL-MNOP-QRST-UVWX-YZ12-3456",
      "productCode": "WELIGHT_STANDARD",
      "customerEmail": "user@example.com",
      "status": "INACTIVE",
      "statusDescription": "未激活",
      "expiredAt": null,
      "maxActivations": 1,
      "currentActivations": 0,
      "remainingActivations": 1,
      "permanent": true,
      "createdAt": "2025-09-24T14:35:33"
    }
  ]
}
```

**注意**: 支付成功后，系统会自动生成许可证并发送到客户邮箱。客户可以通过邮箱查看许可证密钥，然后使用上述接口查询许可证详情。

## 购买流程说明

### 完整购买流程

1. **查询产品信息**: 调用 `GET /products` 获取可购买的产品列表
2. **创建支付订单**: 调用 `POST /payment/orders` 创建订单并获取支付二维码
3. **用户扫码支付**: 用户使用微信扫描二维码完成支付
4. **轮询订单状态**: 调用 `GET /payment/orders/{orderNo}` 轮询订单状态，直到变为 `PAID`
5. **获取许可证**: 支付成功后，系统自动生成许可证并发送到客户邮箱
6. **查询许可证**: 可选择调用 `GET /licenses?customerEmail={email}` 查询许可证列表

### 关键要点

- 所有购买相关接口均**无需认证**
- 订单有效期为30分钟，过期后自动取消
- 许可证会在支付成功后几秒内自动生成并发送邮件
- 建议每3-5秒轮询一次订单状态

## 错误处理

### 统一错误响应格式

```json
{
  "code": 400,
  "message": "错误描述信息",
  "data": null,
  "timestamp": 1758677365048
}
```

### 常见错误码

| 错误码 | 说明 | 常见原因 |
|--------|------|----------|
| 400 | 请求参数错误 | 参数格式错误、必填参数缺失 |
| 404 | 资源不存在 | 产品代码或订单号不存在 |
| 500 | 服务器内部错误 | 系统异常，需联系技术支持 |

### 购买流程常见错误

| 错误信息 | 原因 | 解决方案 |
|----------|------|----------|
| "产品不可购买" | 产品已下架或禁用 | 选择其他可用产品 |
| "订单不存在" | 订单号错误或已过期 | 检查订单号或重新创建订单 |
| "订单已过期" | 订单超过30分钟未支付 | 重新创建订单 |
| "支付失败" | 微信支付异常 | 重试支付或联系客服 |

## 集成建议

### 1. 轮询订单状态
建议每3-5秒轮询一次订单状态，直到状态变为 `PAID` 或 `EXPIRED`。

### 2. 错误重试
网络请求失败时建议重试2-3次，每次重试间隔递增。

### 3. 用户体验
- 创建订单后自动打开支付页面
- 支付成功后提示用户查看邮箱获取许可证
- 提供清晰的支付状态反馈

## 技术支持

如有问题，请联系：
- **QQ群**: [点击加入](https://qm.qq.com/q/UwZnWu2pu8)
- **邮箱**: ilikexff@163.com

---

*文档版本: v1.1*
*最后更新: 2025-09-25*
*更新内容: 修正接口路径，专注于购买流程相关接口*

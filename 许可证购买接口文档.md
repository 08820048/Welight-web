# 许可证购买 API 接口文档

## 概述

本文档专门介绍许可证购买相关的 API 接口，包括产品查询、订单创建、支付处理、许可证获取和激活验证等核心接口。

### 基础信息

- **API 基础地址**: `https://ilikexff.cn/api`
- **数据格式**: JSON
- **字符编码**: UTF-8
- **认证要求**: 所有购买相关接口均**无需认证**

## 接口列表

### 1. 查询产品列表

**接口地址**: `GET /products`

**接口描述**: 获取所有可购买的产品信息

**请求示例**:
```bash
curl -X GET "https://ilikexff.cn/api/products"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": 4,
      "code": "WELIGHT_STANDARD",
      "name": "WeLight标准版",
      "description": "WeLight桌面应用标准版许可证，包含完整功能，永久使用",
      "price": 0.99,
      "currency": "CNY",
      "validityDays": -1,
      "maxActivations": 1,
      "permanent": true
    }
  ]
}
```

### 2. 创建支付订单

**接口地址**: `POST /payment/create-order`

**接口描述**: 创建支付订单并获取支付信息

**请求参数**:
```json
{
  "productCode": "WELIGHT_STANDARD",
  "customerEmail": "user@example.com",
  "customerName": "张三",
  "clientInfo": "WeLight v2.4.2 (MacIntel)",
  "remark": "桌面应用购买"
}
```

**参数说明**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| productCode | string | 是 | 产品代码 |
| customerEmail | string | 是 | 客户邮箱（接收许可证） |
| customerName | string | 否 | 客户姓名 |
| clientInfo | string | 否 | 客户端信息 |
| remark | string | 否 | 备注信息 |

**请求示例**:
```bash
curl -X POST "https://ilikexff.cn/api/payment/create-order" \
  -H "Content-Type: application/json" \
  -d '{
    "productCode": "WELIGHT_STANDARD",
    "customerEmail": "user@example.com",
    "customerName": "张三"
  }'
```

**响应示例**:
```json
{
  "code": 200,
  "message": "订单创建成功",
  "data": {
    "orderNo": "WL1758677365048537F0158C",
    "amount": 0.99,
    "currency": "CNY",
    "productName": "WeLight标准版",
    "qrCode": "weixin://wxpay/bizpayurl?pr=w5cCGAMz1",
    "expiredAt": "2025-09-24T09:59:25",
    "status": "PENDING"
  }
}
```

### 3. 查询订单状态

**接口地址**: `GET /payment/order-status/{orderNo}`

**接口描述**: 查询订单支付状态

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| orderNo | string | 是 | 订单号 |

**请求示例**:
```bash
curl -X GET "https://ilikexff.cn/api/payment/order-status/WL1758677365048537F0158C"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "orderNo": "WL1758677365048537F0158C",
    "status": "PAID",
    "statusDescription": "已支付",
    "amount": 0.99,
    "paidAt": "2025-09-24T09:35:33",
    "licenseGenerated": true
  }
}
```

**订单状态说明**:
| 状态 | 说明 |
|------|------|
| PENDING | 待支付 |
| PAID | 已支付 |
| EXPIRED | 已过期 |
| CANCELLED | 已取消 |

### 4. 获取许可证信息

**接口地址**: `GET /licenses/by-order/{orderNo}`

**接口描述**: 根据订单号获取许可证信息

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| orderNo | string | 是 | 订单号 |

**请求示例**:
```bash
curl -X GET "https://ilikexff.cn/api/licenses/by-order/WL1758677365048537F0158C"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "licenseKey": "ABCD-EFGH-IJKL-MNOP-QRST-UVWX-YZ12-3456",
    "productCode": "WELIGHT_STANDARD",
    "customerEmail": "user@example.com",
    "status": "INACTIVE",
    "statusDescription": "未激活",
    "expiredAt": null,
    "maxActivations": 1,
    "currentActivations": 0,
    "remainingActivations": 1,
    "permanent": true
  }
}
```

### 5. 许可证激活验证

**接口地址**: `POST /licenses/validate`

**接口描述**: 验证并激活许可证

**请求参数**:
```json
{
  "licenseKey": "ABCD-EFGH-IJKL-MNOP-QRST-UVWX-YZ12-3456",
  "customerEmail": "user@example.com",
  "clientInfo": "WeLight v2.4.2 (MacIntel)",
  "deviceFingerprint": "A1B2C3D4E5F6789012345678",
  "deviceName": "张三的MacBook Pro",
  "activate": true
}
```

**参数说明**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| licenseKey | string | 是 | 许可证密钥 |
| customerEmail | string | 是 | 购买时的邮箱 |
| clientInfo | string | 否 | 客户端信息 |
| deviceFingerprint | string | 是 | 设备指纹（唯一标识） |
| deviceName | string | 否 | 设备名称 |
| activate | boolean | 否 | 是否激活新设备，默认false |

**请求示例**:
```bash
curl -X POST "https://ilikexff.cn/api/licenses/validate" \
  -H "Content-Type: application/json" \
  -d '{
    "licenseKey": "ABCD-EFGH-IJKL-MNOP-QRST-UVWX-YZ12-3456",
    "customerEmail": "user@example.com",
    "deviceFingerprint": "A1B2C3D4E5F6789012345678",
    "activate": true
  }'
```

**响应示例**:
```json
{
  "code": 200,
  "message": "许可证验证成功",
  "data": {
    "valid": true,
    "status": "ACTIVE",
    "licenseInfo": {
      "licenseKey": "ABCD-EFGH-IJKL-MNOP-QRST-UVWX-YZ12-3456",
      "productCode": "WELIGHT_STANDARD",
      "customerEmail": "user@example.com",
      "maxActivations": 1,
      "currentActivations": 1,
      "remainingActivations": 0,
      "permanent": true,
      "expired": false
    }
  }
}
```

## 错误处理

### 统一错误响应格式

```json
{
  "code": 400,
  "message": "错误描述信息",
  "data": null,
  "timestamp": 1758677365048
}
```

### 常见错误码

| 错误码 | 说明 | 常见原因 |
|--------|------|----------|
| 400 | 请求参数错误 | 参数格式错误、必填参数缺失 |
| 404 | 资源不存在 | 产品代码、订单号或许可证不存在 |
| 409 | 资源冲突 | 许可证已达到最大激活数 |
| 500 | 服务器内部错误 | 系统异常，需联系技术支持 |

### 许可证验证常见错误

| 错误信息 | 原因 | 解决方案 |
|----------|------|----------|
| "许可证不存在" | 许可证密钥错误 | 检查许可证密钥是否正确 |
| "邮箱不匹配" | 邮箱与购买时不一致 | 使用购买时的邮箱地址 |
| "许可证已过期" | 许可证超过有效期 | 联系客服或重新购买 |
| "激活设备数已达上限" | 超过最大激活数 | 先取消其他设备激活 |
| "许可证已被撤销" | 许可证被管理员撤销 | 联系客服处理 |

## 集成建议

### 1. 轮询订单状态
建议每3-5秒轮询一次订单状态，直到状态变为 `PAID` 或 `EXPIRED`。

### 2. 设备指纹生成
设备指纹应该是设备的唯一标识，建议使用硬件信息生成，确保同一设备每次生成的指纹一致。

### 3. 错误重试
网络请求失败时建议重试2-3次，每次重试间隔递增。

### 4. 用户体验
- 创建订单后自动打开支付页面
- 支付成功后提示用户查看邮箱
- 提供许可证输入界面
- 激活成功后保存许可证信息

## 技术支持

如有问题，请联系：
- **QQ群**: [点击加入](https://qm.qq.com/q/UwZnWu2pu8)
- **邮箱**: ilikexff@163.com

---

*文档版本: v1.0*
*最后更新: 2025-09-25*
